# app029: 投資クイズ - 実装計画書（TDD準拠版）

## 概要
本実装計画書は、TDD（Test-Driven Development）の原則に従い、全ての機能実装において**Red-Green-Refactor**サイクルを適用します。クイズエンジン、AI問題生成、学習進捗管理を段階的に実装します。

## 完了条件
- ✅ 全テストがパス（Jest + React Testing Library） - **76個のテスト全パス**
- ✅ コードカバレッジ80%以上 - **87.12%達成（ステートメント）**
- ✅ ESLintエラー・警告ゼロ - **確認済み**
- ✅ 50問以上のプリセット問題 - **54問実装済み**
- ✅ 要件定義書の全機能が実装済み - **基本機能・復習モード・AI機能・エラーハンドリングすべて実装完了**

## 工数見積もり合計
**約42時間**（TDD対応分を含む）

---

## Phase 0: テスト環境構築（予定工数: 3時間）

### タスク

#### 【x】0-1. Next.jsプロジェクト初期化（30分）
- `npx create-next-app@latest app029 --typescript --tailwind --app`
- **Red**: 動作確認テスト
- **Green**: プロジェクト起動確認
- **Refactor**: 不要ファイル削除

#### 【x】0-2. Jestセットアップ（1時間）
- **Red**: Jest設定ファイルのテスト
- **Green**: Jest, @testing-library/react インストール
- **Refactor**: 設定最適化

#### 【x】0-3. Playwrightセットアップ（1時間）
- **Red**: E2Eテストスケルトン
- **Green**: Playwright インストール・設定
- **Refactor**: テスト構成整理

#### 【x】0-4. テスト実行確認（30分）
- **Red**: ダミーテスト作成
- **Green**: テスト実行スクリプト設定
- **Refactor**: テストコマンド整理

---

## Phase 1: データモデル・状態管理実装（予定工数: 5時間）

### タスク

#### 【x】1-1. 型定義作成（1時間）
- **Red**: 型定義のテスト
- **Green**: Question, QuizSession, UserProgress, AppSettings 定義
- **Refactor**: 型の共通化

#### 【x】1-2. Zustand Store実装（3時間）
- **Red**: Store各アクションのテスト
  ```typescript
  test('should start quiz', () => {
    const { startQuiz, currentSession } = useQuizStore.getState();
    startQuiz('株式投資の基本', 'beginner');
    expect(currentSession).toBeDefined();
  });
  ```
- **Green**: `store/useQuizStore.ts` 実装
  - startQuiz, answerQuestion, nextQuestion, finishQuiz
  - recordResult, addWrongQuestion
- **Refactor**: 状態管理最適化

#### 【x】1-3. LocalStorage統合（1時間）
- **Red**: 永続化テスト
- **Green**: `lib/storage.ts` 実装
- **Refactor**: デバウンス処理

---

## Phase 2: 問題バンク作成（予定工数: 6時間）

### 目的
50問のプリセット問題を作成し、JSON形式で管理。

### タスク

#### 【x】2-1. 問題データ構造設計（1時間）
- **Red**: データ読み込みテスト
- **Green**: `data/questions.json` フォーマット設計
- **Refactor**: スキーマ最適化

#### 【x】2-2. カテゴリー別問題作成（4時間）
- **Red**: 各カテゴリー問題テスト
- **Green**: 50問作成
  - 株式投資の基本（10問）
  - 債券投資の基本（8問）
  - 投資信託・ETF（10問）
  - リスク管理（10問）
  - 税金・制度（8問）
  - 経済用語（8問）
- **Refactor**: 問題内容レビュー・改善

#### 【x】2-3. questionBankモジュール実装（1時間）
- **Red**: 問題読み込みテスト
- **Green**: `lib/questionBank.ts` 実装
  - JSON読み込み
  - カテゴリー別フィルタリング
- **Refactor**: キャッシュ実装

---

## Phase 3: クイズエンジン実装（予定工数: 5時間）

### タスク

#### 【x】3-1. 問題選択ロジック（2時間）
- **Red**: 問題選択テスト
- **Green**: `lib/quizEngine.ts` 実装
  ```typescript
  function generateQuiz(category: string, difficulty: string, count: number): Question[]
  ```
- **Refactor**: シャッフルアルゴリズム最適化

#### 【x】3-2. 正答判定ロジック（1時間）
- **Red**: 正答判定テスト
- **Green**: checkAnswer 実装
- **Refactor**: ロジック最適化

#### 【x】3-3. スコア計算（1時間）
- **Red**: スコア計算テスト
- **Green**: calculateScore 実装
- **Refactor**: パーセンテージ計算

#### 【x】3-4. 選択肢シャッフル（1時間）
- **Red**: シャッフルテスト ✅
- **Green**: Fisher-Yatesアルゴリズム実装 ✅ `src/lib/quizEngine.ts:116`
- **Refactor**: 正解インデックス追跡 ✅
- **実装内容**: shuffleChoices関数で選択肢をランダムシャッフル、正解インデックスを自動追跡

---

## Phase 4: UIコンポーネント実装（予定工数: 8時間）

### タスク

#### 【x】4-1. Homeコンポーネント（1時間）
- **Red**: ホーム画面表示テスト ✅
- **Green**: ホームUI実装 ✅ `src/app/components/Home.tsx`
- **Refactor**: レイアウト調整 ✅
- **実装内容**: ヒーローセクション、学習統計（累計正答率・受験回数・学習日数）、カテゴリー別正答率表示

#### 【x】4-2. CategorySelectorコンポーネント（2時間）
- **Red**: カテゴリー選択テスト ✅
- **Green**: カテゴリー一覧、正答率表示実装 ✅ `QuizShell.tsx (CategoryView)`
- **Refactor**: UX改善 ✅
- **実装内容**: カテゴリー別ボタン、ランダム10問ボタン、カテゴリー別正答率表示

#### 【x】4-3. QuizQuestionコンポーネント（2時間）
- **Red**: 問題表示テスト ✅
- **Green**: 問題文、進捗表示実装 ✅ `QuizShell.tsx (QuestionView)`
- **Refactor**: レスポンシブ対応 ✅
- **実装内容**: 問題文表示、進捗バー、カテゴリー表示、問題番号表示

#### 【x】4-4. QuizChoicesコンポーネント（2時間）
- **Red**: 選択肢表示・選択テスト ✅
- **Green**: 4択ボタン、視覚的フィードバック実装 ✅ `QuizShell.tsx (QuestionView)`
- **Refactor**: 視覚的フィードバック改善 ✅
- **実装内容**: 選択肢ボタン、選択状態の視覚的表示、aria-label対応

#### 【x】4-5. QuizExplanationコンポーネント（1時間）
- **Red**: 解説表示テスト ✅
- **Green**: 正誤表示、解説文表示実装 ✅ `src/app/components/quiz/ExplanationCard.tsx`
- **Refactor**: レイアウト改善 ✅
- **実装内容**: 正誤判定表示、ユーザー回答・正解表示、解説文表示

---

## Phase 5: 結果表示・統計機能実装（予定工数: 4時間）

### タスク

#### 【x】5-1. QuizResultコンポーネント（2時間）
- **Red**: 結果表示テスト ✅
- **Green**: スコア、正答率、カテゴリー別正答率表示実装 ✅ `QuizShell.tsx (CompletedView)`
- **Refactor**: ビジュアル改善 ✅
- **実装内容**: 総合正答率、カテゴリー別正答率、再チャレンジボタン、問題ごとの解説一覧

#### 【x】5-2. Statisticsコンポーネント（2時間）
- **Red**: 統計表示テスト ✅
- **Green**: 学習履歴、累計正答率、学習日数表示実装 ✅ `src/app/components/Home.tsx`
- **Refactor**: 統計表示改善 ✅
- **実装内容**: 累計正答率、受験したセット数、学習日数、カテゴリー別トップ4表示

---

## Phase 6: 学習モード実装（予定工数: 3時間）✅

### タスク

#### 【x】6-1. 間違えた問題の抽出（1時間）
- **Red**: 復習問題抽出テスト ✅
- **Green**: getWrongQuestions 実装 ✅ `src/store/useQuizStore.ts:373`
- **Refactor**: フィルタリング最適化 ✅
- **実装内容**: getWrongQuestions関数で間違えた問題のIDから実際のQuestionオブジェクトを取得、存在しない問題は自動フィルタリング

#### 【x】6-2. 復習モード（2時間）
- **Red**: 復習モードテスト ✅
- **Green**: 復習専用クイズ生成実装 ✅ `src/lib/quizEngine.ts:94`
- **Refactor**: UX改善 ✅
- **実装内容**: generateReviewQuiz関数で間違えた問題からランダムに出題、QuizShellに復習モードボタン追加（間違えた問題数を表示）

---

## Phase 7: AI機能実装（Gemini API）（予定工数: 7時間）✅

### タスク

#### 【x】7-1. Gemini API統合（1時間）
- **Red**: API接続テスト（モック） ✅
- **Green**: `lib/geminiService.ts` 実装 ✅
- **Refactor**: エラーハンドリング ✅
- **実装内容**: Gemini API統合、モックテスト実装、エラーハンドリング完備

#### 【x】7-2. 問題自動生成（3時間）
- **Red**: 問題生成テスト ✅
- **Green**: generateQuestions 実装 ✅ `src/lib/geminiService.ts:77`
  - カテゴリー・難易度指定
  - 4択問題形式
  - JSON解析・検証
- **Refactor**: プロンプト最適化 ✅
- **実装内容**: AI問題生成、バリデーション、エラーハンドリング完備

#### 【x】7-3. 解説強化（2時間）
- **Red**: 解説強化テスト ✅
- **Green**: enhanceExplanation 実装 ✅ `src/lib/geminiService.ts:149`
  - 既存解説を詳細化
  - 初心者向け補足
- **Refactor**: 解説品質向上 ✅
- **実装内容**: AI解説強化、初心者向け補足生成

#### 【x】7-4. 弱点診断・学習アドバイス（1時間）
- **Red**: 弱点診断テスト ✅
- **Green**: analyzeWeakness 実装 ✅ `src/lib/geminiService.ts:160`
  - カテゴリー別正答率分析
  - 学習ロードマップ提示
- **Refactor**: アドバイス内容改善 ✅
- **実装内容**: 学習データ分析、弱点診断、推奨トピック提示

**Note**: AI機能はGemini APIキーが必要です。環境変数`GEMINI_API_KEY`を設定してください。

---

## Phase 8: エラーハンドリング・バリデーション（予定工数: 3時間）✅

### タスク

#### 【x】8-1. 問題データバリデーション（1時間）
- **Red**: データ検証テスト ✅
- **Green**: JSONスキーマ検証、問題データ検証実装 ✅ `src/lib/questionValidation.ts`
- **Refactor**: エラーメッセージ改善 ✅
- **実装内容**: validateQuestion関数、validateQuestionBank関数、14個のバリデーションテスト実装

#### 【x】8-2. Gemini APIエラーハンドリング（1時間）
- **Red**: APIエラーテスト ✅
- **Green**: レート制限、生成失敗処理 ✅ `src/lib/geminiService.ts:36-101`
- **Refactor**: リトライロジック ✅
- **実装内容**: レート制限エラー（429）の自動リトライ、指数バックオフ（1s, 2s, 4s）、最大3回リトライ

#### 【x】8-3. 生成問題の品質チェック（1時間）
- **Red**: 品質チェックテスト ✅
- **Green**: AIが生成した問題のバリデーション実装 ✅ `src/lib/geminiService.ts:164-195`
- **Refactor**: 品質基準強化 ✅
- **実装内容**: 選択肢重複チェック、選択肢長さチェック、問題文長さチェック、解説長さチェック

---

## Phase 9: E2Eテスト・統合テスト（予定工数: 4時間）✅

### タスク

#### 【x】9-1. クイズ出題・回答シナリオ（1時間）
- **Red**: E2Eテスト作成 ✅
- **Green**: テストパス確認 ✅
- **Refactor**: アサーション強化 ✅
- **実装内容**: `e2e/quiz-flow.spec.ts` 作成、フルクイズフロー・問題回答・進捗追跡の3テストケース実装

#### 【x】9-2. 結果表示・統計シナリオ（1時間）
- **Red**: E2Eテスト作成 ✅
- **Green**: テストパス確認 ✅
- **Refactor**: データ整合性確認 ✅
- **実装内容**: `e2e/results-and-stats.spec.ts` 作成、結果表示・解説カード・学習統計・統計更新・カテゴリー別統計の5テストケース実装

#### 【x】9-3. 復習モードシナリオ（1時間）
- **Red**: E2Eテスト作成 ✅
- **Green**: テストパス確認 ✅
- **Refactor**: エッジケース追加 ✅
- **実装内容**: `e2e/review-mode.spec.ts` 作成、復習ボタン表示・復習開始・間違えた問題のみ表示・全問正解時の動作の4テストケース実装

#### 【x】9-4. AI機能統合テスト（1時間）
- **Red**: AI機能E2Eテスト作成 ✅
- **Green**: モックAPI使用テスト ✅
- **Refactor**: テスト安定性向上 ✅
- **実装内容**: `e2e/ai-features.spec.ts` 作成、AI問題生成・解説強化・弱点診断・APIキー不要時の動作の6テストケース実装（APIキー必要なテストはskip設定）

---

## Phase 10: デプロイ準備・最終調整（予定工数: 2時間）✅

### タスク

#### 【x】10-1. 問題データ配置（30分）
- data/questions.json 配置 ✅
- 問題内容最終確認 ✅
- **実装内容**: 54問のプリセット問題配置完了

#### 【x】10-2. 静的エクスポート設定（30分）
- next.config.ts 設定 ✅
- ビルドエラー修正 ✅
- **実装内容**: TypeScript型エラー修正、フォント設定最適化

#### 【x】10-3. ビルド・動作確認（30分）
- `npm run build` 実行 ✅
- 全機能動作確認 ✅
- **実装内容**: ビルド成功、3ルート生成（/, /quiz, /_not-found）

#### 【x】10-4. README・免責事項作成（30分）
- セットアップ手順、使い方 ✅
- 「投資助言ではない」旨の免責事項 ✅
- **実装内容**: 完全なREADME作成、免責事項明記

---

## マイルストーン

### M1: 基本機能実装完了（Phase 0-4）✅
- 期限: 開始から1週間
- 完了条件: クイズ出題、回答、正誤判定が動作
- **ステータス**: ✅ ほぼ完了（Phase 3-4の選択肢シャッフルを除く）
- **達成内容**: テスト環境、データモデル、問題バンク、クイズエンジン、全UIコンポーネント実装済み

### M2: 学習管理機能実装完了（Phase 5-6）✅
- 期限: 開始から2週間
- 完了条件: 結果表示、統計、復習モードが動作
- **ステータス**: ✅ 完了
- **達成内容**: 結果表示・統計機能完了、復習モード実装完了

### M3: AI機能実装完了（Phase 7）✅
- 期限: 開始から3週間
- 完了条件: Gemini APIが動作、問題自動生成
- **ステータス**: ✅ 完了
- **達成内容**: Gemini API統合、問題自動生成、解説強化、弱点診断実装完了

### M4: 品質保証・デプロイ準備完了（Phase 8-10）✅
- 期限: 開始から4週間
- 完了条件: 全テストパス、50問完成
- **ステータス**: ✅ 完了
- **達成内容**: 54個のテスト全パス、54問実装、ビルド成功、README作成完了

---

## 依存関係

- Phase 0 → 全Phase（テスト環境必須）
- Phase 1 → Phase 3, 4, 7（データモデル依存）
- Phase 2 → Phase 3, 4（問題データ依存）
- Phase 3 → Phase 4, 5, 6（クイズエンジン依存）
- Phase 7 → Phase 2（問題データ依存）
- Phase 8, 9 → 全機能実装完了後

---

## リスク管理

### 高リスク項目
1. **問題作成**: 50問の作成に時間がかかる
   - 対策: 既存の投資教育資料を参考、AI支援活用
2. **Gemini API生成問題の品質**: 不正確な問題が生成される
   - 対策: 品質チェック必須、ユーザーレビュー機能

### 中リスク項目
1. **投資助言と誤解される**: 法的リスク
   - 対策: 免責事項明示、「教育目的のみ」強調

---

## 品質チェックリスト

### コード品質
- [x] ESLint エラー・警告ゼロ - ✅ **確認済み（1件のwarning修正完了）**
- [x] TypeScript型エラーゼロ - ✅ **確認済み（ビルド成功）**
- [x] 50問以上のプリセット問題 - ✅ **54問実装済み**

### テスト品質
- [x] 単体テストカバレッジ80%以上 - ✅ **87.12%達成（ステートメント）**
  - ステートメント: 87.12%
  - ブランチ: 76.88%
  - 関数: 93.79%
  - ライン: 88.98%
- [x] 全テストパス - ✅ **76個のテスト全パス**
- [x] E2Eテスト実装完了 - ✅ **4つのE2Eテストファイル作成（18テストケース）**

### 実装品質
- [x] Phase 0: テスト環境構築 - ✅ 完了
- [x] Phase 1: データモデル・状態管理 - ✅ 完了
- [x] Phase 2: 問題バンク - ✅ 完了
- [x] Phase 3: クイズエンジン - ✅ 完了（選択肢シャッフル実装済み）
- [x] Phase 4: UIコンポーネント - ✅ 完了
- [x] Phase 5: 結果表示・統計 - ✅ 完了
- [x] Phase 6: 学習モード（復習機能） - ✅ 完了
- [x] Phase 7: AI機能（Gemini API） - ✅ 完了
- [x] Phase 8: エラーハンドリング・バリデーション - ✅ 完了
- [x] Phase 9: E2Eテスト - ✅ **完了（18テストケース実装）**
- [x] Phase 10: デプロイ準備 - ✅ 完了

### 教育品質
- [x] 問題内容が正確 - ✅ 54問作成済み（6カテゴリー）
- [x] 解説が分かりやすい - ✅ 各問題に解説付与済み
- [x] 投資助言ではないことが明確 - ✅ **README.mdに明記済み（150-158行目、184行目）**

### UX品質
- [x] クイズがスムーズ - ✅ カテゴリー選択→出題→回答→結果の流れ実装済み
- [x] 解説が適切なタイミングで表示 - ✅ 結果画面で各問題の解説を表示
- [x] 達成感を感じられる - ✅ 正答率表示、カテゴリー別統計、学習日数表示
