# Phase 13 要件定義書：AI機能のUI統合

## 1. 背景・目的

### 1.1 現状の課題
- 投資クイズアプリには、Gemini APIを利用した以下のAI機能が実装されている：
  - 問題の自動生成（generateQuestions）
  - 解説の強化（enhanceExplanation）
  - 弱点診断とアドバイス（analyzeWeakness）
- Phase 11でAPIキー設定UIは実装されたが、これらのAI機能を呼び出すUIボタンが存在しない
- ユーザーはAI機能の恩恵を受けられず、「AI使ってる感が全然ない」状態

### 1.2 目的
- 既存のAI機能をユーザーが簡単に利用できるUIを提供する
- ユーザーの学習体験を向上させる
- APIキー設定済みユーザーに対して、AI機能の価値を体感してもらう

## 2. ユーザーニーズ

### 2.1 ターゲットユーザー
- 投資の基礎知識を学びたい初心者〜中級者
- より詳しい解説を求めるユーザー
- 自分の弱点を把握し、効率的に学習したいユーザー

### 2.2 ユーザーストーリー
1. **問題生成機能**
   - "既存の問題をやり尽くしたので、新しい問題で学習したい"
   - "特定のカテゴリーで集中的に練習したい"

2. **解説強化機能**
   - "問題の解説がわかりにくい時、もっと詳しい説明が欲しい"
   - "専門用語の補足説明が欲しい"

3. **弱点診断機能**
   - "自分の弱点がどこにあるか知りたい"
   - "効率的な学習方法のアドバイスが欲しい"

## 3. 機能要件

### 3.1 Phase 13-1: ホーム画面に弱点診断ボタン追加

#### 機能概要
- ホーム画面（`Home.tsx`）に「弱点診断」ボタンを追加
- ボタン押下時に `analyzeWeakness()` を呼び出し
- 診断結果をモーダルまたはダイアログで表示

#### 表示要件
- **ボタン配置**: 既存の「クイズスタート」「復習モード」ボタンと同じデザイン系統
- **ボタンラベル**: "🔍 弱点診断" または "📊 学習アドバイス"
- **表示条件**:
  - APIキーが設定されている場合のみ表示
  - 未設定の場合は「設定」ページへの誘導メッセージ

#### 診断結果の表示内容
- 最も正答率が低いカテゴリー
- 弱点の詳細分析（2-3文）
- 具体的な学習アドバイス（3-4文）
- 推奨される学習トピック（3項目）

#### エラーハンドリング
- APIキー未設定時：「APIキーを設定してください」メッセージ + 設定ページへのリンク
- API呼び出し失敗時：「診断に失敗しました。もう一度お試しください」メッセージ
- 学習データ不足時：「まずはクイズに挑戦して、学習データを蓄積してください」メッセージ

### 3.2 Phase 13-2: 結果画面に解説強化ボタン追加

#### 機能概要
- クイズ完了画面（`ExplanationCard.tsx`）に「解説をもっと詳しく」ボタンを追加
- ボタン押下時に `enhanceExplanation()` を呼び出し
- 強化された解説を元の解説と置き換え、または追加表示

#### 表示要件
- **ボタン配置**: 各問題カードの解説エリア下部
- **ボタンラベル**: "📖 もっと詳しく" または "✨ AI解説"
- **表示条件**:
  - APIキーが設定されている場合のみ表示
  - 既に強化解説を取得済みの問題には「取得済み」バッジ表示

#### 強化解説の表示方法
- **展開式**: ボタン押下で解説エリアが展開される
- **元の解説を保持**: 強化解説は追加情報として表示
- **マークダウン対応**: 強化解説はマークダウン形式で表示可能

#### ローディング表示
- API呼び出し中は「解説を生成中...」スピナー表示
- 生成完了後は自動的に解説を表示

#### エラーハンドリング
- APIキー未設定時：ボタンを非表示にする
- API呼び出し失敗時：「解説の生成に失敗しました」メッセージ + リトライボタン
- ネットワークエラー時：適切なエラーメッセージ

### 3.3 Phase 13-3: クイズ画面にAI問題生成ボタン追加

#### 機能概要
- クイズ画面（`QuizShell.tsx`）のカテゴリー選択画面に「AI問題生成」ボタンを追加
- ボタン押下時に問題生成パラメータ（カテゴリー、難易度、問題数）を選択させる
- `generateQuestions()` を呼び出して新しい問題を生成
- 生成された問題でクイズを開始

#### 表示要件
- **ボタン配置**: カテゴリー選択エリアの下部または独立したセクション
- **ボタンラベル**: "✨ AI問題を生成" または "🤖 新問題作成"
- **表示条件**:
  - APIキーが設定されている場合のみ表示
  - 未設定の場合はボタンをdisabled状態で表示し、ツールチップで設定を促す

#### 問題生成パラメータ選択UI
- **カテゴリー選択**: ドロップダウンまたはボタンリスト
- **難易度選択**: 初級・中級・上級のラジオボタン
- **問題数選択**: 3問・5問・10問のラジオボタン
- **デフォルト値**: カテゴリー="株式投資の基本", 難易度="初級", 問題数=5問

#### 問題生成フロー
1. ユーザーがパラメータを選択
2. 「生成する」ボタンを押下
3. API呼び出し中は「問題を生成中...」ローディング表示（進捗バー付き）
4. 生成完了後、自動的にクイズを開始
5. 生成された問題は一時的なものとして扱い、永続化しない（オプション）

#### エラーハンドリング
- APIキー未設定時：ボタンdisabled + 設定ページへの誘導
- API呼び出し失敗時：「問題の生成に失敗しました」メッセージ + リトライボタン
- 品質チェック失敗時：「問題の品質チェックに失敗しました。もう一度お試しください」
- ネットワークエラー時：適切なエラーメッセージ

## 4. 非機能要件

### 4.1 パフォーマンス
- **API呼び出しタイムアウト**: 30秒以内
- **ローディング表示**: 2秒以上かかる処理には必ずスピナー表示
- **レスポンシブ**: 全てのUI要素はモバイル・タブレット・デスクトップで適切に表示

### 4.2 ユーザビリティ
- **ローディング状態の明示**: API呼び出し中はローディング表示で進行状況を示す
- **エラーメッセージの明確性**: エラー発生時は具体的な原因と対処方法を提示
- **APIキー状態の可視性**: 設定済み/未設定の状態を常に明示

### 4.3 セキュリティ
- **APIキーの保護**: APIキーはローカルストレージに保存され、サーバーに送信しない
- **入力検証**: ユーザー入力（カテゴリー、難易度等）は必ずバリデーション
- **エラーメッセージの安全性**: エラーメッセージにAPIキーや機密情報を含めない

### 4.4 保守性
- **コンポーネント分離**: AI機能UIは独立したコンポーネントとして実装
- **テスタビリティ**: 全てのAI機能UIはユニットテストとE2Eテストでカバー
- **コード品質**: ESLintルールに準拠、TypeScript型定義を完備

### 4.5 互換性
- **既存機能への影響ゼロ**: 既存のクイズフロー、統計機能に影響を与えない
- **段階的デグレード**: APIキー未設定時でも、既存機能は正常に動作
- **ブラウザ互換性**: Chrome、Firefox、Safari、Edgeの最新版で動作

## 5. ユースケース

### 5.1 弱点診断のユースケース

**前提条件**:
- ユーザーがAPIキーを設定済み
- ユーザーが少なくとも1回以上クイズを受験済み

**基本フロー**:
1. ユーザーがホーム画面で「弱点診断」ボタンをクリック
2. システムが学習データを収集し、`analyzeWeakness()` を呼び出す
3. ローディング表示が表示される（2〜5秒）
4. 診断結果がモーダルで表示される
5. ユーザーが結果を確認し、モーダルを閉じる

**代替フロー**:
- 3a. API呼び出しが失敗した場合
  - エラーメッセージを表示
  - リトライボタンを提供
- 3b. 学習データが不足している場合
  - 「まずはクイズに挑戦してください」メッセージを表示

### 5.2 解説強化のユースケース

**前提条件**:
- ユーザーがAPIキーを設定済み
- ユーザーがクイズを完了し、結果画面を表示中

**基本フロー**:
1. ユーザーが結果画面で特定の問題の「もっと詳しく」ボタンをクリック
2. システムが `enhanceExplanation()` を呼び出す
3. ローディング表示が表示される（3〜8秒）
4. 強化された解説が展開表示される
5. ユーザーが解説を読む

**代替フロー**:
- 3a. API呼び出しが失敗した場合
  - エラーメッセージを表示
  - リトライボタンを提供
- 3b. 既に強化解説を取得済みの場合
  - 即座に取得済みの解説を表示（API呼び出しをスキップ）

### 5.3 AI問題生成のユースケース

**前提条件**:
- ユーザーがAPIキーを設定済み

**基本フロー**:
1. ユーザーがクイズ画面（カテゴリー選択）で「AI問題を生成」ボタンをクリック
2. 問題生成パラメータ選択UIが表示される
3. ユーザーがカテゴリー・難易度・問題数を選択
4. ユーザーが「生成する」ボタンをクリック
5. システムが `generateQuestions()` を呼び出す
6. ローディング表示が表示される（5〜15秒）
7. 生成された問題でクイズが開始される
8. ユーザーが通常通りクイズに回答

**代替フロー**:
- 6a. API呼び出しが失敗した場合
  - エラーメッセージを表示
  - リトライボタンを提供
  - パラメータ選択UIに戻る
- 6b. 問題の品質チェックが失敗した場合
  - エラーメッセージを表示
  - 自動的にリトライ（最大3回）
  - 3回失敗した場合はユーザーにエラーを通知

## 6. 受入基準

### 6.1 Phase 13-1: 弱点診断ボタン

#### 機能面
- ✅ ホーム画面に弱点診断ボタンが表示される
- ✅ APIキー未設定時はボタンが非表示またはdisabled状態
- ✅ ボタン押下時に `analyzeWeakness()` が正しく呼び出される
- ✅ 診断結果が見やすいフォーマットで表示される
- ✅ エラー時に適切なエラーメッセージが表示される

#### テスト面
- ✅ APIキー設定済み・未設定の両方のケースでテスト
- ✅ API呼び出し成功・失敗の両方のケースでテスト
- ✅ 学習データあり・なしの両方のケースでテスト
- ✅ ユニットテスト: カバレッジ80%以上
- ✅ E2Eテスト: 診断フローの完全な自動テスト

### 6.2 Phase 13-2: 解説強化ボタン

#### 機能面
- ✅ 結果画面の各問題カードに「もっと詳しく」ボタンが表示される
- ✅ APIキー未設定時はボタンが非表示
- ✅ ボタン押下時に `enhanceExplanation()` が正しく呼び出される
- ✅ 強化解説がマークダウン形式で正しく表示される
- ✅ ローディング中はスピナーが表示される
- ✅ 既に取得済みの解説はキャッシュされる

#### テスト面
- ✅ APIキー設定済み・未設定の両方のケースでテスト
- ✅ API呼び出し成功・失敗の両方のケースでテスト
- ✅ マークダウン形式の解説が正しく表示されることを確認
- ✅ ユニットテスト: カバレッジ80%以上
- ✅ E2Eテスト: 解説強化フローの完全な自動テスト

### 6.3 Phase 13-3: AI問題生成ボタン

#### 機能面
- ✅ クイズ画面に「AI問題を生成」ボタンが表示される
- ✅ APIキー未設定時はボタンがdisabled状態
- ✅ パラメータ選択UIが正しく表示される
- ✅ パラメータ選択後、`generateQuestions()` が正しく呼び出される
- ✅ 生成された問題でクイズが開始される
- ✅ 生成中はローディング表示（進捗バー付き）
- ✅ エラー時に適切なエラーメッセージとリトライボタンが表示される

#### テスト面
- ✅ APIキー設定済み・未設定の両方のケースでテスト
- ✅ API呼び出し成功・失敗の両方のケースでテスト
- ✅ 全てのパラメータ組み合わせで問題生成をテスト
- ✅ 生成された問題の品質チェックが機能することを確認
- ✅ ユニットテスト: カバレッジ80%以上
- ✅ E2Eテスト: 問題生成フローの完全な自動テスト

### 6.4 全体品質基準

#### コード品質
- ✅ ESLintエラー・警告がゼロ
- ✅ TypeScript型エラーがゼロ
- ✅ 全ての新規コンポーネントにTSDoc/JSDocコメント

#### テストカバレッジ
- ✅ ステートメントカバレッジ: 87%以上を維持
- ✅ ブランチカバレッジ: 80%以上
- ✅ 全テストがパス（既存76件 + Phase 13新規テスト）

#### パフォーマンス
- ✅ API呼び出しタイムアウトが正しく機能（30秒）
- ✅ ローディング表示が2秒以上の処理で必ず表示される
- ✅ モバイル環境でも快適に動作

#### セキュリティ
- ✅ APIキーがエラーメッセージに含まれない
- ✅ APIキーがクライアントサイドで適切に保護される
- ✅ ユーザー入力が適切にバリデーションされる

## 7. 実装スコープ外

以下は Phase 13 のスコープに含まれない：

- 生成された問題の永続化（データベースへの保存）
- 問題生成履歴の管理
- AI機能の使用回数制限・課金機能
- 複数ユーザーのためのマルチテナント対応
- 問題生成のカスタマイズ（出題形式の変更等）
- 解説のお気に入り・ブックマーク機能
- ソーシャルシェア機能（診断結果をSNSで共有）

## 8. 制約事項

### 8.1 技術的制約
- Gemini APIのレート制限（429エラー）に対する指数バックオフは既に実装済み
- APIキーはローカルストレージに保存される（サーバーサイド保存なし）
- 生成された問題は一時的なものとし、永続化しない

### 8.2 デザイン制約
- 既存のデザインシステム（Tailwind CSS）に準拠
- ボタン・モーダル・フォームは既存のスタイルと統一感を持たせる

### 8.3 予算・スケジュール制約
- Phase 13 は1セッション内で完了することを目標とする
- API呼び出しコストを考慮し、過度なテストは避ける

## 9. 参照ドキュメント

- `app029/src/lib/geminiService.ts` - AI機能の実装
- `app029/src/lib/apiKeyManager.ts` - APIキー管理機能
- `doc/implementation.md` - 全体実装計画書
- `doc/phase13-technical-design.md` - Phase 13 技術設計書（次のステップで作成）

## 10. 承認

| 役割 | 氏名 | 承認日 |
|------|------|--------|
| プロダクトオーナー | あおいさん | - |
| 開発担当 | クロ（Claude Code CLI） | 2025-11-13 |

---

**作成日**: 2025-11-13
**最終更新日**: 2025-11-13
**バージョン**: 1.0
